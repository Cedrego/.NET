@page "/preinscripcion"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject LaboratorioNET.Services.MongoDbService MongoDbS
@inject LaboratorioNET.Services.SesionService SesionService
@using LaboratorioNET.Entities

<PageTitle>Preinscripción</PageTitle>

<div class="background-container">
    <div class="main-container">
        <div class="form-container">
            <h2>Preinscripción a Carrera</h2>
            <div class="subtitle">Completa tu inscripción</div>

            @if (!SesionService.EstaAutenticado)
            {
                <div class="warning-message">
                    <p>⚠️ Debes iniciar sesión para inscribirte a una carrera</p>
                    <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/iniciar_sesion")'>
                        Ir a Iniciar Sesión
                    </button>
                </div>
            }
            else
            {
                <div class="user-info">
                    <p><strong>👤 Corredor:</strong> @corredorActual?.Nombre</p>
                    <p><strong>📋 Documento:</strong> @corredorActual?.DocumentoIdentidad</p>
                </div>

                <div class="form-group">
                    <label><strong>🏃 Selecciona una Carrera:</strong></label>
                    <select @bind="FormData.IDCarrera" class="form-select">
                        <option value="">-- Seleccione una carrera --</option>
                        @foreach (var carrera in CarrerasDisponibles)
                        {
                            var inscritos = registrosPorCarrera.ContainsKey(carrera.IdCarrera) 
                                ? registrosPorCarrera[carrera.IdCarrera] 
                                : 0;
                            var disponibles = carrera.LimiteParticipantes - inscritos;
                            var estaCompleta = disponibles <= 0;

                            <option value="@carrera.IdCarrera" disabled="@estaCompleta">
                                @carrera.Nombre - @carrera.Tipo 
                                (@carrera.FechaInicio.ToLocalTime().ToString("dd/MM/yyyy"))
                                [@(estaCompleta ? "COMPLETA" : $"{disponibles} cupos")]
                            </option>
                        }
                    </select>
                    @if (CarrerasDisponibles.Count == 0)
                    {
                        <small class="helper-text">No hay carreras disponibles en este momento</small>
                    }
                </div>

                @if (!string.IsNullOrEmpty(FormData.IDCarrera))
                {
                    var carreraSeleccionada = CarrerasDisponibles.FirstOrDefault(c => c.IdCarrera == FormData.IDCarrera);
                    if (carreraSeleccionada != null)
                    {
                        <div class="carrera-info">
                            <h3>📍 Detalles de la Carrera</h3>
                            <p><strong>Nombre:</strong> @carreraSeleccionada.Nombre</p>
                            <p><strong>Tipo:</strong> @carreraSeleccionada.Tipo</p>
                            <p><strong>Lugar de Salida:</strong> @carreraSeleccionada.LugarSalida</p>
                            <p><strong>Fecha:</strong> @carreraSeleccionada.FechaInicio.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Límite:</strong> @carreraSeleccionada.LimiteParticipantes participantes</p>
                            <p><strong>Checkpoints:</strong> @carreraSeleccionada.CantSecciones</p>
                        </div>
                    }
                }

                <div class="form-group">
                    <label><strong>👤 Nombre Completo:</strong></label>
                    <input type="text" 
                           class="form-input" 
                           @bind="FormData.NombreCompleto" 
                           readonly 
                           style="background-color: #f0f0f0;" />
                    <small class="helper-text">Dato obtenido de tu perfil</small>
                </div>

                <div class="form-group">
                    <label><strong>📋 Documento de Identidad:</strong></label>
                    <input type="text" 
                           class="form-input" 
                           @bind="FormData.IdentifiCorredor" 
                           readonly 
                           style="background-color: #f0f0f0;" />
                    <small class="helper-text">Dato obtenido de tu perfil</small>
                </div>

                <div class="form-group">
                    <label><strong>📱 Teléfono de Contacto:</strong></label>
                    <input type="tel" 
                           class="form-input" 
                           placeholder="Ingrese su teléfono" 
                           @bind="FormData.Telefono" />
                    <small class="helper-text">Puede modificar su teléfono si es necesario</small>
                </div>

                <div class="button-container">
                    <button class="btn btn-primary" 
                            @onclick="SubmitForm" 
                            disabled="@(IsLoading || string.IsNullOrEmpty(FormData.IDCarrera))">
                        @(IsLoading ? "⏳ Procesando..." : "✅ Confirmar Inscripción")
                    </button>

                    <button class="btn btn-secondary" 
                            @onclick='() => Navigation.NavigateTo("/menu-corredor")'>
                        ← Volver al Menú
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="message @MessageType">
                        @Message
                    </div>
                }
            }
        </div>
    </div>
</div>

<style>
    .background-container {
        background-image: url('images/2.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
    }

    .main-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 90vh;
    }

    .form-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 30px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-container h2 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
    }

    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 25px;
        font-size: 14px;
    }

    .user-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    .user-info p {
        margin: 5px 0;
        color: #1976d2;
    }

    .warning-message {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
    }

    .warning-message p {
        color: #856404;
        font-weight: 500;
        margin-bottom: 15px;
    }

    .carrera-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .carrera-info h3 {
        margin-top: 0;
        color: #495057;
        font-size: 1.2em;
    }

    .carrera-info p {
        margin: 8px 0;
        color: #495057;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .helper-text {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #666;
        font-style: italic;
    }

    .button-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 25px;
    }

    .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background-color: #28a745;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        font-weight: 500;
        text-align: center;
    }

    .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    @@media (max-width: 768px) {
        .form-container {
            padding: 20px;
        }
    }
</style>

@code {
    private PreinscripcionForm FormData = new PreinscripcionForm();
    private List<CarreraInfo> CarrerasDisponibles = new List<CarreraInfo>();
    private Dictionary<string, int> registrosPorCarrera = new Dictionary<string, int>();
    private Corredor? corredorActual;
    
    private bool IsLoading = false;
    private string Message = "";
    private string MessageType = "";

    private class PreinscripcionForm
    {
        public string IDCarrera { get; set; } = "";
        public string IdentifiCorredor { get; set; } = "";
        public string NombreCompleto { get; set; } = "";
        public string Telefono { get; set; } = "";
    }

    private class CarreraInfo
    {
        public string IdCarrera { get; set; } = "";
        public string Nombre { get; set; } = "";
        public string Tipo { get; set; } = "";
        public string LugarSalida { get; set; } = "";
        public int LimiteParticipantes { get; set; }
        public int CantSecciones { get; set; }
        public DateTime FechaInicio { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Verificar si hay sesión activa
            if (!SesionService.EstaAutenticado)
            {
                Message = "⚠️ Debes iniciar sesión para inscribirte";
                MessageType = "error";
                return;
            }

            // Obtener datos del corredor desde la sesión
            var documentoSesion = SesionService.DocumentoIdentidad;
            
            if (string.IsNullOrEmpty(documentoSesion))
            {
                Message = "❌ No se pudo obtener tu información de usuario";
                MessageType = "error";
                return;
            }

            // Cargar datos completos del corredor
            corredorActual = await MongoDbS.ObtenerCorredorPorDocumentoAsync(documentoSesion);

            if (corredorActual == null)
            {
                Message = "❌ No se encontró tu información de corredor";
                MessageType = "error";
                return;
            }

            // Autocompletar el formulario con los datos del corredor
            FormData.NombreCompleto = corredorActual.Nombre;
            FormData.IdentifiCorredor = corredorActual.DocumentoIdentidad;
            FormData.Telefono = corredorActual.Telefono ?? "";

            // Cargar carreras disponibles
            await CargarCarreras();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error inicializando: {ex.Message}");
            Message = "❌ Error al cargar la información";
            MessageType = "error";
        }
    }

    private async Task CargarCarreras()
    {
        try
        {
            var todasLasCarreras = await MongoDbS.ObtenerTodasCarrerasAsync();
            var now = DateTime.UtcNow;

            // Filtrar carreras disponibles para inscripción
            var carrerasAbiertas = todasLasCarreras
                .Where(c => !c.Terminada && 
                           now >= c.FechaInicioInsc && 
                           now < c.FechaInicio)
                .ToList();

            // Contar registros por carrera
            foreach (var carrera in carrerasAbiertas)
            {
                var registros = await MongoDbS.ObtenerRegistrosPorCarreraAsync(carrera.IdCarrera);
                registrosPorCarrera[carrera.IdCarrera] = registros.Count;
            }

            // Mapear a CarreraInfo
            CarrerasDisponibles = carrerasAbiertas
                .Select(c => new CarreraInfo
                {
                    IdCarrera = c.IdCarrera,
                    Nombre = c.Nombre,
                    Tipo = c.Tipo,
                    LugarSalida = c.LugarSalida,
                    LimiteParticipantes = c.LimiteParticipantes,
                    CantSecciones = c.CantSecciones,
                    FechaInicio = c.FechaInicio
                })
                .OrderBy(c => c.FechaInicio)
                .ToList();

            Console.WriteLine($"✅ Se cargaron {CarrerasDisponibles.Count} carreras disponibles");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando carreras: {ex.Message}");
        }
    }

    private async Task SubmitForm()
    {
        Message = "";
        MessageType = "";

        // Validaciones
        if (string.IsNullOrWhiteSpace(FormData.IDCarrera))
        {
            Message = "❌ Por favor seleccione una carrera";
            MessageType = "error";
            return;
        }

        if (string.IsNullOrWhiteSpace(FormData.Telefono))
        {
            Message = "❌ Por favor ingrese su teléfono de contacto";
            MessageType = "error";
            return;
        }

        IsLoading = true;
        StateHasChanged();

        try
        {
            // Verificar si ya está inscrito
            var registroExistente = await MongoDbS.ObtenerRegistroCorredorEnCarreraAsync(
                FormData.IDCarrera, 
                FormData.IdentifiCorredor
            );

            if (registroExistente != null)
            {
                Message = "⚠️ Ya estás inscrito en esta carrera";
                MessageType = "error";
                IsLoading = false;
                StateHasChanged();
                return;
            }

            // Verificar cupos disponibles
            var carrera = await MongoDbS.ObtenerCarreraPorIdCarreraAsync(FormData.IDCarrera);
            if (carrera == null)
            {
                Message = "❌ Carrera no encontrada";
                MessageType = "error";
                IsLoading = false;
                StateHasChanged();
                return;
            }

            var registrosExistentes = await MongoDbS.ObtenerRegistrosPorCarreraAsync(FormData.IDCarrera);
            if (registrosExistentes.Count >= carrera.LimiteParticipantes)
            {
                Message = "❌ Lo sentimos, esta carrera ya alcanzó el límite de participantes";
                MessageType = "error";
                IsLoading = false;
                StateHasChanged();
                return;
            }

            // Actualizar teléfono si cambió
            if (corredorActual != null && corredorActual.Telefono != FormData.Telefono)
            {
                corredorActual.Telefono = FormData.Telefono;
                await MongoDbS.ActualizarCorredorAsync(corredorActual.Id!, corredorActual);
            }

            // Generar número de dorsal
            int numDorsal = await GenerarNumDorsalUnico(FormData.IDCarrera);

            // Crear registro
            var nuevoRegistro = new Registro
            {
                IDCarrera = FormData.IDCarrera,
                IdentifiCorredor = FormData.IdentifiCorredor,
                NumDorsal = numDorsal,
                Tiempos = new List<DateTime>()
            };

            bool resultado = await MongoDbS.AgregarRegistroAsync(nuevoRegistro);

            if (resultado)
            {
                Message = $"✅ ¡Inscripción exitosa! Tu número de dorsal es: {numDorsal}";
                MessageType = "success";
                Console.WriteLine($"✅ Inscripción exitosa: {FormData.NombreCompleto} - Dorsal: {numDorsal}");

                // Esperar y redirigir
                await Task.Delay(3000);
                Navigation.NavigateTo("/menu-corredor");
            }
            else
            {
                Message = "❌ No se pudo completar la inscripción. Intente nuevamente.";
                MessageType = "error";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error en inscripción: {ex.Message}");
            Message = "❌ Error al procesar la inscripción. Intente nuevamente.";
            MessageType = "error";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task<int> GenerarNumDorsalUnico(string idCarrera)
    {
        Random random = new Random();
        int numDorsal;
        bool existe;

        do
        {
            numDorsal = random.Next(1000, 9999);
            var registros = await MongoDbS.ObtenerRegistrosPorCarreraAsync(idCarrera);
            existe = registros.Any(r => r.NumDorsal == numDorsal);
        } while (existe);

        return numDorsal;
    }
}