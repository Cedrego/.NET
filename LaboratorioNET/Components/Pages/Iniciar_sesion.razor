@page "/iniciar_sesion"
@rendermode InteractiveServer
@using LaboratorioNET.Services
@using LaboratorioNET.Entities
@inject NavigationManager Navigation
@inject FirebaseService FirebaseService
@inject SesionService SesionService

<PageTitle>Iniciar Sesión</PageTitle>

<div class="background-container">
    <div class="main-container">
        <header class="page-title-box">
            <h1>SportEvent Manager</h1>
        </header>

        <div class="login-box">
            <h2>Iniciar Sesión</h2>

            <div class="form-container">
                <!-- Documento de Identidad -->
                <div class="form-group">
                    <label><strong>Documento de Identidad:</strong></label>
                    <InputText @bind-Value="documentoIdentidad" 
                            class="form-input" 
                            placeholder="Ingrese su documento" />
                </div>

                <!-- Contraseña -->
                <div class="form-group">
                    <label><strong>Contraseña:</strong></label>
                    <InputText @bind-Value="contrasena" 
                            type="password" 
                            class="form-input" 
                            placeholder="Ingrese su contraseña" />
                </div>

                <!-- Mensaje de error -->
                @if (!string.IsNullOrEmpty(mensajeError))
                {
                    <div class="error-message">
                        <p>@mensajeError</p>
                    </div>
                }

                <!-- Botones -->
                <div class="button-container">
                    <button type="button" 
                            class="btn-primary" 
                            @onclick="IniciarSesion" 
                            disabled="@estaCargando">
                        @if (estaCargando)
                        {
                            <span>Verificando...</span>
                        }
                        else
                        {
                            <span>Iniciar Sesión</span>
                        }
                    </button>

                    <button type="button" 
                            class="btn-secondary" 
                            @onclick='() => Navigation.NavigateTo("/crear_cuenta")'>
                        Crear Cuenta
                    </button>
                </div>

                <div class="footer-links">
                    <a href="/">Volver al inicio</a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string documentoIdentidad = string.Empty;
    private string contrasena = string.Empty;
    private string mensajeError = string.Empty;
    private bool estaCargando = false;

    private async Task IniciarSesionYNavegar()
    {
        await IniciarSesion();
    }

    private async Task IniciarSesion()
    {
        mensajeError = string.Empty;

        if (string.IsNullOrWhiteSpace(documentoIdentidad))
        {
            mensajeError = "Por favor ingrese su documento de identidad.";
            return;
        }

        if (string.IsNullOrWhiteSpace(contrasena))
        {
            mensajeError = "Por favor ingrese su contraseña.";
            return;
        }

        estaCargando = true;
        StateHasChanged();

        try
        {
            var corredorDoc = await FirebaseService.Corredores
                .Document(documentoIdentidad.Trim())
                .GetSnapshotAsync();

            if (!corredorDoc.Exists)
            {
                mensajeError = "Usuario no encontrado. Verifique su documento de identidad.";
                estaCargando = false;
                StateHasChanged();
                return;
            }

            var corredor = corredorDoc.ConvertTo<Corredor>();

            if (corredor.Contraseña != contrasena)
            {
                mensajeError = "Contraseña incorrecta.";
                estaCargando = false;
                StateHasChanged();
                return;
            }

            // Verificar el rol del corredor
            if (corredor.Rol == "admin")
            {
                mensajeError = "Los administradores no pueden acceder desde esta página.";
                estaCargando = false;
                StateHasChanged();
                return;
            }

            // ✅ Login exitoso si el rol no es "admin"
            SesionService.IniciarSesion(corredor.DocumentoIdentidad, corredor.Nombre);
            
            // ✅ Forzar actualización del estado
            StateHasChanged();
            
            // ✅ Navegar al menú del corredor
            Navigation.NavigateTo("/menu-corredor", forceLoad: false);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al iniciar sesión: {ex.Message}";
            Console.WriteLine($"❌ Error: {ex}");
            estaCargando = false;
            StateHasChanged();
        }
    }

}